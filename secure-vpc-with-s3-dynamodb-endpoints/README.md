# AWSで作る！セキュア＆高可用性インフラ構築ハンズオン

## はじめに

このハンズオンガイドへようこそ！
本ガイドでは、AWSの主要サービスを組み合わせ、セキュリティと可用性（止まりにくさ）を考慮した基本的なインフラ構成を、AWS初心者の方でもゼロから構築する手順を解説します。

### 🎯 このハンズオンで学べること

*   独立したプライベートなネットワーク空間（VPC）の設計と構築
*   冗長性を確保するためのマルチAZ（アベイラビリティゾーン）構成
*   インターネットに直接公開しないセキュアなサーバー（EC2）の配置
*   AWSネットワーク内でサービス間を安全に接続するVPCエンドポイントの利用
*   サーバーに直接ログインせず、安全に操作するためのセッションマネージャーの活用
*   基本的なDDoS攻撃からインフラを保護するAWS Shield Standardの役割

### 📈 完成する構成の概要

このハンズオンを完了すると、下図のような構成が完成します。外部からの直接的なアクセスを遮断しつつ、サーバーからはVPCエンドポイントを経由してS3やDynamoDB、SSMといったAWSサービスとプライベートに通信できる、セキュアな環境です。

```
[AWS Cloud]
  |
  +-- [VPC: 10.0.0.0/16]
        |
        +-- (IGW) <--> AWS Public Endpoints (SSM, S3, DynamoDB)
        |
        +-- [Route Table] --> VPC Endpoint for S3
        |               --> VPC Endpoint for DynamoDB
        |
        +-- [Private Subnet 1 (AZ-a): 10.0.1.0/24]
        |     |
        |     +-- [EC2 Instance (Private)]
        |
        +-- [Private Subnet 2 (AZ-c): 10.0.2.0/24]
              |
              +-- [EC2 Instance (Private)]
```

```Mermaid
graph TD
    A["AWS Cloud"] --> B["VPC: 10.0.0.0/16"]

    subgraph B
        C["Internet Gateway (IGW)"]
        D["Route Table"]
        E["Private Subnet 1 (AZ-a)<br>10.0.1.0/24"]
        F["Private Subnet 2 (AZ-c)<br>10.0.2.0/24"]
    end

    G["AWS Public Endpoints<br>(SSM, S3, DynamoDB)"]
    H["VPC GW Endpoint (S3)"]
    I["VPC GW Endpoint (DynamoDB)"]
    L["VPC IF Endpoint (SSM)"]
    J["EC2 Instance (Private)"]
    K["EC2 Instance (Private)"]

    C <--> G
    B --> L
    D --> H
    D --> I
    E --> J
    F --> K
```

### ✅ 前提条件

*   AWSアカウントが作成済みであること。
*   基本的なAWSマネジメントコンソールの操作（ログイン、サービス検索など）に慣れていること。

### ⚠️【重要】無料利用枠に関する注意喚起

このハンズオンは、AWSの**無料利用枠の範囲内**で完了できるように設計されています。以下の点を必ず守ってください。

*   **EC2インスタンスタイプ**: `t3.micro` または同等の無料枠対象インスタンスを選択します。
*   **AMI**: `Amazon Linux 2023 AMI` の無料利用枠対象イメージを選択します。
*   **ハンズオン終了後のクリーンアップ**: ハンズオン完了後、意図しない課金を防ぐために、**必ず末尾の「まとめとクリーンアップ」セクションの手順に従って作成したリソースをすべて削除してください。**

それでは、構築を始めましょう！

---

## 1. S3バケットの作成

**目的**: EC2インスタンスからアクセスするための、オブジェクトストレージ（ファイル置き場）を作成します。

1.  AWSマネジメントコンソールで「S3」を検索し、S3のダッシュボードを開きます。
2.  **[バケットを作成]** をクリックします。
3.  **バケット名**: `hands-on-secure-infra-bucket-あなたの名前や日付など` のように、世界中の誰とも重複しない一意な名前を入力します。
    > **なぜ？**: S3バケット名は全世界で一意である必要があります。
4.  **AWSリージョン**: ハンズオンを進めるリージョン（例: `アジアパシフィック (東京) ap-northeast-1`）を選択します。以降のすべてのリソースは、このリージョンで作成します。
5.  **パブリックアクセスをすべてブロック**: この設定が**チェックされたまま**になっていることを確認します。これにより、意図せずバケットの中身がインターネットに公開されるのを防ぎます。
6.  その他の設定はすべてデフォルトのまま、画面下部の **[バケットを作成]** をクリックします。

## 2. DynamoDBテーブルの作成

**目的**: EC2インスタンスからアクセスするための、フルマネージドNoSQLデータベースを作成します。

1.  AWSマネジメントコンソールで「DynamoDB」を検索し、DynamoDBのダッシュボードを開きます。
2.  **[テーブルの作成]** をクリックします。
3.  **テーブル名**: `HandsOnSecureInfraTable` と入力します。
4.  **パーティションキー**: `id` と入力し、タイプは `文字列` を選択します。
    > **パーティションキーとは？**: データの格納場所を決めるための主キーです。各データ項目（アイテム）を一位に識別するために使われます。
5.  **テーブル設定**: **[デフォルト設定]** が選択されていることを確認します。これにより、無料利用枠を超えにくいオンデマンドキャパシティモードで作成されます。
6.  画面下部の **[テーブルの作成]** をクリックします。

## 3. ネットワークの構築 (VPC)

**目的**: AWSクラウド上に、他のネットワークから論理的に分離された、あなた専用のプライベートネットワーク空間を構築します。

### 3.1. VPCの作成

1.  AWSマネジメントコンソールで「VPC」を検索し、VPCのダッシュボードを開きます。
2.  左側のナビゲーションペインから **[お使いのVPC]** をクリックします。
3.  **[VPCを作成]** をクリックします。
4.  **作成するリソース**: **[VPCなど]** ではなく **[VPCのみ]** を選択します。
    > **なぜ？**: 今回はVPCの各コンポーネントを一つずつ手動で作成することで、ネットワーク構成の理解を深めるためです。
5.  **名前タグ**: `HandsOn-VPC` と入力します。
6.  **IPv4 CIDR ブロック**: `10.0.0.0/16` と入力します。
    > **CIDRとは？**: このVPC内で使用できるIPアドレスの範囲を定義する表記法です。`10.0.0.0` から `10.0.255.255` までの約65,000個のアドレスが利用可能になります。
7.  **[VPCを作成]** をクリックします。

### **3.1.1. VPCのDNS設定を有効化**

**目的**: VPCエンドポイント（特にセッションマネージャー用）が正常に機能するために、VPCのDNS関連設定を有効化します。

1. VPCダッシュボードの左側ナビゲーションペインから **[お使いのVPC]** をクリックします。
2. VPCの一覧から作成した `HandsOn-VPC` を選択します。
3. **[アクション]** > **[VPC の設定を編集]** を選択します。
4. 以下の2つの項目に**必ずチェックを入れます**。
	* **[DNS ホスト名を有効化]**
	* **[DNS 解決を有効化]**
5. **[変更を保存]** をクリックします。

### 3.2. インターネットゲートウェイ (IGW) の作成とアタッチ

**目的**: VPCがAWSの各種サービス（今回はセッションマネージャーなど）と通信するために、インターネットへの出入り口を作成します。

1.  左側のナビゲーションペインから **[インターネットゲートウェイ]** をクリックします。
2.  **[インターネットゲートウェイの作成]** をクリックします。
3.  **名前タグ**: `HandsOn-IGW` と入力します。
4.  **[インターネットゲートウェイの作成]** をクリックします。
5.  作成した `HandsOn-IGW` を選択し、**[アクション]** > **[VPCにアタッチ]** をクリックします。
6.  **[利用可能なVPC]** から先ほど作成した `HandsOn-VPC` を選択し、**[インターネットゲートウェイのアタッチ]** をクリックします。

### 3.3. プライベートサブネットの作成

**目的**: 可用性を高めるために、異なる2つのアベイラビリティゾーン（AZ）に、インターネットから直接アクセスできないサブネットを作成します。

1.  左側のナビゲーションペインから **[サブネット]** をクリックします。
2.  **[サブネットを作成]** をクリックします。
3.  **VPC ID**: `HandsOn-VPC` を選択します。
4.  **サブネットの設定** で以下のように入力します（**1つ目のサブネット**）。
    *   **サブネット名**: `HandsOn-PrivateSubnet-1a`
    *   **アベイラビリティゾーン**: `ap-northeast-1a` など、末尾が `a` のAZを選択します。
    *   **IPv4 CIDR ブロック**: `10.0.1.0/24`
5.  **[新しいサブネットを追加]** をクリックし、続けて**2つ目のサブネット**の情報を入力します。
    *   **サブネット名**: `HandsOn-PrivateSubnet-1c`
    *   **アベイラビリティゾーン**: `ap-northeast-1c` など、**1つ目とは異なるAZ**（末尾が `c` など）を選択します。
    *   **IPv4 CIDR ブロック**: `10.0.2.0/24`
6.  **[サブネットを作成]** をクリックします。

## 4. IAMロールの作成 (EC2用)

**目的**: EC2インスタンスに「役割（ロール）」を与え、S3、DynamoDB、およびセッションマネージャーサービスへのアクセス許可を安全に付与します。

1.  AWSマネジメントコンソールで「IAM」を検索し、IAMのダッシュボードを開きます。
2.  左側のナビゲーションペインから **[ロール]** をクリックし、**[ロールを作成]** をクリックします。
3.  **信頼されたエンティティを選択**:
    *   **信頼されたエンティティタイプ**: **[AWS のサービス]** を選択。
    *   **ユースケース**: **[EC2]** を選択し、**[次へ]** をクリックします。
4.  **許可を追加**: 以下の3つのポリシーを検索し、チェックボックスをオンにします。
    *   `AmazonS3FullAccess` （S3へのアクセス用）
    *   `AmazonDynamoDBFullAccess` （DynamoDBへのアクセス用）
    *   `AmazonSSMManagedInstanceCore` （セッションマネージャー接続に**必須**）
    > **補足**: 実運用では、必要な操作のみを許可する「最小権限の原則」に従い、より限定的なポリシーを作成することが推奨されます。今回はハンズオンの簡略化のため、AWS管理ポリシーを使用します。
5.  **[次へ]** をクリックします。
6.  **ロール名**: `HandsOn-EC2-Role` と入力します。
7.  内容を確認し、**[ロールを作成]** をクリックします。

## 5. プライベートEC2インスタンスの作成

**目的**: 構築したプライベートサブネット内に、アプリケーションサーバーとなるEC2インスタンスを2台（冗長構成）作成します。

1.  AWSマネジメントコンソールで「EC2」を検索し、EC2のダッシュボードを開きます。
2.  **[インスタンスを起動]** をクリックします。
3.  **名前**: `HandsOn-Private-EC2-1a` と入力します。
4.  **アプリケーションおよび OS イメージ (Amazon マシンイメージ)**:
    *   `Amazon Linux` を選択。
    *   AMIは `Amazon Linux 2023 AMI` が選択されていることを確認します。「無料利用枠の対象」と表示されているはずです。
5.  **インスタンスタイプ**: `t3.micro` を選択します。「無料利用枠の対象」と表示されているはずです。
6.  **キーペア (ログイン)**: **[キーペアなしで続行]** を選択します。
    > **なぜ？**: 今回はSSH接続を使わず、よりセキュアなセッションマネージャーを利用して接続するため、SSHキーは不要です。
7.  **ネットワーク設定**: **[編集]** をクリックします。
    *   **VPC**: `HandsOn-VPC` を選択。
    *   **サブネット**: `HandsOn-PrivateSubnet-1a` を選択。
    *   **パブリックIPの自動割り当て**: **[無効化]** を選択します。これがプライベートインスタンスであるための重要な設定です。
    *   **ファイアウォール (セキュリティグループ)**: **[セキュリティグループを作成する]** を選択。
        *   **セキュリティグループ名**: `HandsOn-EC2-SG`
        *   **説明**: `Security group for HandsOn EC2`
        *   **インバウンドセキュリティグループのルール**: **デフォルトのルールを削除します。** ルールが何もない状態にします。
        > **なぜ？**: セッションマネージャーは、インスタンスへのインバウンド（受信）ポートを開ける必要がなく、より安全に接続できます。
8.  **高度な詳細** を展開します。
    *   **IAM インスタンスプロフィール**: ステップ4で作成した `HandsOn-EC2-Role` を選択します。
9.  **[インスタンスを起動]** をクリックします。
10. **同様の手順で2台目のインスタンスを作成します。** 変更点は以下の通りです。
    *   **名前**: `HandsOn-Private-EC2-1c`
    *   **ネットワーク設定** > **サブネット**: `HandsOn-PrivateSubnet-1c` を選択。
    *   **ファイアウォール (セキュリティグループ)**: **[既存のセキュリティグループを選択する]** を選び、`HandsOn-EC2-SG` を選択します。
    *   その他の設定は1台目とすべて同じです。

## 6. VPCエンドポイントの作成 (S3/DynamoDB用)

**目的**: インターネットを経由せず、AWSのプライベートネットワーク内でVPCとS3/DynamoDBを接続するための「専用トンネル」を作成します。

1.  VPCのダッシュボードに戻ります。
2.  左側のナビゲーションペインから **[エンドポイント]** をクリックします。
3.  **[エンドポイントを作成]** をクリックします。
4.  **名前タグ**: `HandsOn-S3-Endpoint` と入力します。
5.  **サービスカテゴリ**: **[AWS のサービス]** を選択します。
6.  **サービス**: 「s3」で検索し、タイプが **`Gateway`** となっている `com.amazonaws.ap-northeast-1.s3` を選択します。（リージョン名はあなたのリージョンに合わせてください）
7.  **VPC**: `HandsOn-VPC` を選択します。
8.  **ルートテーブル**: `HandsOn-PrivateSubnet-1a` と `HandsOn-PrivateSubnet-1c` に関連付けられているルートテーブルの両方にチェックを入れます。
9.  **[エンドポイントを作成]** をクリックします。
10. **再度 [エンドポイントを作成] をクリックし、DynamoDB用も同様に作成します。**
    *   **名前タグ**: `HandsOn-DynamoDB-Endpoint`
    *   **サービス**: 「dynamodb」で検索し、タイプが **`Gateway`** となっている `com.amazonaws.ap-northeast-1.dynamodb` を選択します。
    *   **VPC** と **ルートテーブル** はS3の時と同様に設定します。
    *   **[エンドポイントを作成]** をクリックします。

## **7. 【追記】VPCエンドポイントの作成 (セッションマネージャー用)**

**目的**: プライベートEC2インスタンスがセッションマネージャーのサービスと通信できるように、「専用トンネル（インターフェイスエンドポイント）」を作成します。これには3つのエンドポイントが必要です。

### **7.1. エンドポイント用セキュリティグループの作成**

1.  EC2のダッシュボードに移動し、左側ペインの **[セキュリティグループ]** をクリックします。
2.  **[セキュリティグループを作成]** をクリックします。
    *   **セキュリティグループ名**: `HandsOn-Endpoint-SG`
    *   **説明**: `SG for VPC Interface Endpoints`
    *   **VPC**: `HandsOn-VPC` を選択します。
    *   **インバウンドルール**で **[ルールを追加]** をクリックします。
        *   **タイプ**: `HTTPS` (ポート443)
        *   **ソース**: ステップ5で作成したEC2インスタンスのセキュリティグループ `HandsOn-EC2-SG` のIDを選択します。
3.  **[セキュリティグループを作成]** をクリックします。

### **7.2. インターフェイスエンドポイントの作成 (3つ)**

VPCダッシュボードに戻り、**[エンドポイント]** > **[エンドポイントを作成]** をクリックし、以下の3つを順番に作成します。

**【1つ目: ssm】**
*   **サービス**: `com.amazonaws.ap-northeast-1.ssm` を検索して選択 (リージョン名はご利用環境に合わせる)。
*   **VPC**: `HandsOn-VPC` を選択。
*   **サブネット**: `HandsOn-PrivateSubnet-1a` と `HandsOn-PrivateSubnet-1c` の両方にチェック。
*   **セキュリティグループ**: 作成した `HandsOn-Endpoint-SG` を選択。
*   **[エンドポイントを作成]** をクリック。

**【2つ目: ssmmessages】**
*   **サービス**: `com.amazonaws.ap-northeast-1.ssmmessages` を選択。
*   **VPC、サブネット、セキュリティグループ**は上記と同じ設定。
*   **[エンドポイントを作成]** をクリック。

**【3つ目: ec2messages】**
*   **サービス**: `com.amazonaws.ap-northeast-1.ec2messages` を選択。
*   **VPC、サブネット、セキュリティグループ**は上記と同じ設定。
*   **[エンドポイントを作成]** をクリック。

## 8. AWS Shield Standard について

**目的**: AWSが提供する基本的なDDoS保護サービスについて理解します。

**AWS Shield Standard** は、すべてのAWS顧客に対して追加料金なしで自動的に有効化されるDDoS（分散型サービス妨害）攻撃からの保護サービスです。
このハンズオンで作成したインフラも、特に設定作業を行うことなく、ネットワークフローを常時モニタリングするShield Standardによって保護されています。これにより、ウェブサイトやアプリケーションの可用性に影響を与える、最も一般的で頻繁に発生するネットワークレイヤーおよびトランスポートレイヤーのDDoS攻撃が自動的に緩和されます。

## 9. 接続確認

**目的**: 作成したプライベートEC2インスタンスに安全に接続し、VPCエンドポイント経由でS3とDynamoDBにアクセスできることを確認します。

### 9.1. セッションマネージャーでの接続

1.  EC2のダッシュボードに戻り、**[インスタンス]** をクリックします。
2.  作成したインスタンスの `HandsOn-Private-EC2-1a` を選択します。
3.  **[接続]** をクリックします。
4.  **[セッションマネージャー]** タブが選択されていることを確認し、**[接続]** をクリックします。
5.  ブラウザ上で新しいタブが開き、EC2インスタンスのコマンドライン（シェル）が表示されれば接続成功です。

### **9.1.1. 作業ディレクトリへの移動**

**目的**: ファイルの書き込み権限があるディレクトリに移動し、後の操作でのエラーを防ぎます。

1.  セッションマネージャーのシェルが開いたら、まず以下のコマンドを実行して `/tmp` ディレクトリに移動します。

```bash
cd /tmp
```

### 9.2. AWS CLIによるS3へのアクセス確認

EC2インスタンスのセッション内で、以下のコマンドを一行ずつ実行します。
`<作成したバケット名>` の部分は、ステップ1で作成したあなた自身のS3バケット名に置き換えてください。

```bash
# S3バケット一覧を表示
aws s3 ls

# "Hello S3" という内容のテストファイルを作成
echo "Hello S3 from Private EC2" > test.txt

# test.txt ファイルをS3バケットにアップロード
aws s3 cp test.txt s3://<作成したバケット名>/

# バケット内にファイルがアップロードされたことを確認
aws s3 ls s3://<作成したバケット名>/

# S3からファイルをダウンロード
aws s3 cp s3://<作成したバケット名>/test.txt downloaded.txt

# ダウンロードしたファイルの中身を確認
cat downloaded.txt
```

これらのコマンドがすべてエラーなく成功すれば、VPCエンドポイント経由でS3と正常に通信できています。

### 9.3. AWS CLIによるDynamoDBへのアクセス確認

引き続きEC2インスタンスのセッション内で、以下のコマンドを実行します。
リージョンが東京 (`ap-northeast-1`) 以外の場合は、`--region` オプションをあなたのリージョンコードに置き換えてください。

```bash
# DynamoDBテーブルにデータを書き込む (PutItem)
aws dynamodb put-item \
    --table-name HandsOnSecureInfraTable \
    --item '{"id": {"S": "test-001"}, "message": {"S": "Hello DynamoDB from Private EC2"}}' \
    --region ap-northeast-1

# 書き込んだデータを読み取る (GetItem)
aws dynamodb get-item \
    --table-name HandsOnSecureInfraTable \
    --key '{"id": {"S": "test-001"}}' \
    --region ap-northeast-1
```

`put-item` コマンドでエラーが出ず、`get-item` コマンドで書き込んだデータ（Item）がJSON形式で表示されれば、VPCエンドポイント経由でDynamoDBとの通信も成功です。

---

## まとめとクリーンアップ

お疲れ様でした！
このハンズオンでは、AWSのベストプラクティスに沿った、セキュアで冗長なインフラの基礎を構築しました。VPCによるネットワーク分離、プライベートサブネットへのリソース配置、IAMロールによる権限管理、VPCエンドポイントによるプライベート接続など、重要な概念を実践的に学ぶことができました。

### ⚠️【最重要】リソースの削除（クリーンアップ）

**予期せぬ課金を避けるため、作成したリソースを必ず以下の順序で削除してください。**

1.  **EC2インスタンスの終了**:
    *   EC2ダッシュボードで、作成した2台のインスタンス (`HandsOn-Private-EC2-1a`, `HandsOn-Private-EC2-1c`) を選択します。
    *   **[インスタンスの状態]** > **[インスタンスを終了]** をクリックします。

2.  **VPCエンドポイントの削除**:
    *   VPCダッシュボードの **[エンドポイント]** を開きます。
    *   作成した5つのエンドポイント (`HandsOn-S3-Endpoint`, `HandsOn-DynamoDB-Endpoint`, `ssm`, `ssmmessages`, `ec2messages`) をそれぞれ選択し、**[アクション]** > **[VPC エンドポイントの削除]** を実行します。
    
3. **セキュリティグループの削除**:
    *   `HandsOn-Endpoint-SG` を削除します。(`HandsOn-EC2-SG` はVPC削除時に自動で削除されます)

4.  **インターネットゲートウェイのデタッチと削除**:
    *   VPCダッシュボードの **[インターネットゲートウェイ]** を開きます。
    *   `HandsOn-IGW` を選択し、**[アクション]** > **[VPCからデタッチ]** を実行します。
    *   デタッチが完了したら、再度 `HandsOn-IGW` を選択し、**[アクション]** > **[インターネットゲートウェイの削除]** を実行します。

5.  **VPCの削除**:
    *   VPCダッシュボードの **[お使いのVPC]** を開きます。
    *   `HandsOn-VPC` を選択し、**[アクション]** > **[VPCを削除]** をクリックします。
    *   表示されるダイアログで `delete` と入力し、削除を実行します。（この操作で、関連するサブネットやルートテーブルも同時に削除されます。）

6.  **S3バケットの削除**:
    *   S3ダッシュボードを開き、作成したバケットを選択します。
    *   まず **[空にする]** をクリックして、中のオブジェクト（`test.txt`）を削除します。
    *   バケットが空になったら、バケット一覧に戻り、再度バケットを選択して **[削除]** をクリックします。

7.  **DynamoDBテーブルの削除**:
    *   DynamoDBダッシュボードの **[テーブル]** を開きます。
    *   `HandsOnSecureInfraTable` を選択し、**[削除]** をクリックします。

8.  **IAMロールの削除**:
    *   IAMダッシュボードの **[ロール]** を開きます。
    *   `HandsOn-EC2-Role` を検索して選択し、**[削除]** をクリックします。

以上で、すべてのクリーンアップ作業は完了です。
