AWSTemplateFormatVersion: '2010-09-09'
Description: Hands-on 1 secure infrastructure stack (VPC, EC2, EIP, IAM Role for SSM)

Resources:
  # 1. VPC, Subnet, IGW, RouteTable (前回と同様の定義)
  MyFirstVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags: [{Key: Name, Value: my-cfn-vpc}]
  MyPublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref MyFirstVPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      Tags: [{Key: Name, Value: my-cfn-public-subnet}]
  MyInternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags: [{Key: Name, Value: my-cfn-igw}]
  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref MyFirstVPC
      InternetGatewayId: !Ref MyInternetGateway
  MyPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref MyFirstVPC
      Tags: [{Key: Name, Value: my-cfn-public-rtb}]
  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref MyPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref MyInternetGateway
  SubnetRouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref MyPublicSubnet
      RouteTableId: !Ref MyPublicRouteTable

  # 2. IAMロールとインスタンスプロファイルの作成 (セッションマネージャー用)
  MyEC2RoleForSSM:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal: {Service: [ec2.amazonaws.com]}
            Action: ['sts:AssumeRole']
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
  MyInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref MyEC2RoleForSSM

  # 3. セキュリティグループの作成 (SSHルールなし)
  MyWebSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: my-cfn-web-sg-secure
      GroupDescription: Enable HTTP access only
      VpcId: !Ref MyFirstVPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
      Tags: [{Key: Name, Value: my-cfn-web-sg}]

  # 4. EC2インスタンスの起動 (IAMロールをアタッチ)
  MyWebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: ami-025bbcfb04b076789 # Tokyo (ap-northeast-1) Amazon Linux 2023 AMI
      SubnetId: !Ref MyPublicSubnet
      SecurityGroupIds:
        - !Ref MyWebSecurityGroup
      IamInstanceProfile: !Ref MyInstanceProfile
      UserData:
        Fn::Base64: |
          #!/bin/bash
          yum update -y
          yum install -y httpd
          service httpd start
          chkconfig httpd on
          echo "<h1>Hello from Secure CloudFormation!</h1>" > /var/www/html/index.html
      Tags: [{Key: Name, Value: my-cfn-web-server}]

  # 5. Elastic IPの作成と関連付け
  MyEIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId: !Ref MyWebServerInstance
      AllocationId: !GetAtt MyEIP.AllocationId

Outputs:
  WebServerURL:
    Description: URL of the newly created web server
    Value: !Sub 'http://${MyEIP}'
